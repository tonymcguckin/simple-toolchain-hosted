version: '2'

messages:
  $i18n: locales.yml

template:
  name:
    $ref: "$env.byoc_name === undefined ? '#/messages/template.name' : '#/messages/template.byoc_name'"

  description:
    $ref: "#/messages/template.description"

  getting_started:
      $ref: "#/messages/template.description"
  info:
    git url: >-
      $env.repository ? '[' + $env.repository + '](' + $env.repository + ')' : "[https://github.com/tonymcguckin/simple-toolchain-hosted](https://github.com/tonymcguckin/simple-toolchain-hosted)"
    git branch: >-
      $env.repository && $env.branch ? '[' + $env.branch + ']('+ $env.repository + '/tree/' + $env.branch + ')': "[flavour3](https://github.com/tonymcguckin/simple-toolchain-hosted/tree/flavour3)"

toolchain:
  name: "{{template.name}}"

services:
  sample-repo:
    $switch:
      - $expr: default
      - $default: default
        service_id: hostedgit
        parameters:
          env_id: "{{form.pipeline.parameters.env_id}}"
          bucket1: "{{form.pipeline.parameters}}" 
          bucket2: "{{form.pipeline.schema}}" 
          bucket3: "{{form.pipeline}}"
          bucket4: "{{form}}"
          bucket5: "{{template.name}}"
          bucket6: "{{template}}"

  sample-build:
    service_id: pipeline
    parameters:
      services:
        - sample-repo
      name: '{{services.sample-repo.parameters.repo_name}}'
      ui-pipeline: true
      configuration:
        content:
          $text: pipeline.yml
        env:
          SAMPLE_REPO: $env.byoc_name
          SAMPLE_REPO1: $env.byoc_name
          SAMPLE_REPO2: "if($env.env_id === 'eu'){ $env.assign('sample-build-eu.dyml'); } else { '' }"
          CF_APP_NAME: $env.byoc_name || '{{form.pipeline.parameters.prod-app-name}}'
          PROD_SPACE_NAME: $env.prod_space || '{{form.pipeline.parameters.prod-space}}'
          PROD_ORG_NAME: $env.prod_org || '{{form.pipeline.parameters.prod-organization}}'
          PROD_REGION_ID: $env.prod_region || '{{form.pipeline.parameters.prod-region}}'
          API_KEY: '{{form.pipeline.parameters.api-key}}'
        execute: true

  webide:
    service_id: orion

form:
  pipeline:
    parameters:
      env_id: "'ENV_ID:' + $env.env_id"
      env_key: $env.env_key
    schema:
      $ref: deploy.json
